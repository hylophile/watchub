<!DOCTYPE html>
<html>
  <head>
    <title>File Tree</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      meter {
        width: 40px;
        margin-right: 5px;
      }

      ul {
        display: block;
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .file {
        display: inline-block;
        border: 1px solid #aaa;
        border-radius: 100px;
        padding: 0em 1em;
        margin: 0.1em;
        white-space: nowrap;
      }
      .file:hover {
        background-color: #eee;
      }

      .file {
        background-color: white;
        vertical-align: top;
        display: inline-block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 5em;
        width: 20em;
      }

      [data-shorten] .file[data-is-episode] {
        width: 7em;
      }

      .directory {
        background-color: white;
      }

      .directory.open:hover:before {
        /* content: "âŸ¶ "; */
        content: "âž¡ ";
        font-family: "mono";
        cursor: pointer;
      }
      .directory:hover:before {
        /* content: "âŸ¶ "; */
        content: "âž¡ ";
        font-family: "mono";
        cursor: pointer;
      }

      .directory.open:before {
        content: "- ";
        font-family: "mono";
        cursor: pointer;
      }

      .directory:before {
        content: "+ ";
        width: 5em;
        font-family: "mono";
        cursor: pointer;
      }

      .directory > span {
        font-weight: 500;
        cursor: pointer;
      }

      .file {
        cursor: pointer;
      }

      li.directory > ul {
        display: none;
      }
      li.directory.open > ul {
        display: block;
      }

      .hidden {
        display: none;
      }

      /* add CSS rule to apply different padding-left values to each level */
      #file-tree ul {
        padding-left: 2ch;
      }

      #file-tree {
        padding: 2em 12.5%;
        margin: auto;
      }

      fieldset {
        height: max-content;
        background-color: #ffffff77;
        min-width: max-content;
        position: fixed;
        right: 10px;
        top: 10px;
      }
    </style>
  </head>
  <body style="margin: 0; padding: 0; height: 100vh" data-shorten="">
    <!-- <h1>File Tree</h1> -->
    <div style="height: 100%">
      <ul id="file-tree">
        {{ render_node(tree)|safe }}
      </ul>
      <fieldset>
        <legend>Options</legend>
        <div>
          <input type="checkbox" id="show-folded" name="show-folded" />
          <label for="show-folded">Folded directories</label>
        </div>
        <div>
          <input type="checkbox" id="show-finished" name="show-finished" />
          <label for="show-finished">Finished files</label>
        </div>
        <div>
          <input type="checkbox" id="show-full-name" name="show-full-name" />
          <label for="show-full-name">Full filenames</label>
        </div>
      </fieldset>
    </div>
    <script>
      function toggleFullName(b) {
        const els = [...document.querySelectorAll(".filename")];
        if (b) {
          els.forEach(
            (el) =>
              (el.innerText = el
                .closest(".file")
                .getAttribute("data-full-name"))
          );
        } else {
          els.forEach(
            (el) =>
              (el.innerText = el
                .closest(".file")
                .getAttribute("data-short-name"))
          );
        }
        document.body.toggleAttribute("data-shorten", !b);
        localStorage.setItem("showFullName", b);
      }

      function toggleFoldedDirectories(b) {
        const els = document.querySelectorAll(".directory:not(.open)");
        els.forEach((el) => el.classList.toggle("hidden", !b));
        localStorage.setItem("showFolded", b);
      }

      function toggleFinishedFiles(b) {
        const els = [...document.querySelectorAll("meter[value='100']")].map(
          (el) => el.closest(".directory,.file")
        );
        els.forEach((el) => el.classList.toggle("hidden", !b));
        localStorage.setItem("showFinished", b);
      }

      document.title =
        "ðŸŒˆ " + decodeURI(location.pathname.split("/").pop()) + " â€” watchub";

      const foldedState = JSON.parse(
        localStorage.getItem("foldedState") ?? "{}"
      );
      Object.keys(foldedState).forEach((dir) => {
        const el = document.querySelector(`[data-path='${dir}']`);
        if (el) {
          el.classList.toggle("open");
        }
      });

      const showFolded = JSON.parse(
        localStorage.getItem("showFolded") ?? "true"
      );
      document.querySelector("#show-folded").checked = showFolded;
      toggleFoldedDirectories(showFolded);
      document
        .querySelector("#show-folded")
        .addEventListener("click", (evt) => {
          toggleFoldedDirectories(evt.target.checked);
        });

      const showFinished = JSON.parse(
        localStorage.getItem("showFinished") ?? "true"
      );
      document.querySelector("#show-finished").checked = showFinished;
      toggleFinishedFiles(showFinished);
      document
        .querySelector("#show-finished")
        .addEventListener("click", (evt) => {
          toggleFinishedFiles(evt.target.checked);
        });

      const showFullName = JSON.parse(
        localStorage.getItem("showFullName") ?? "true"
      );
      document.querySelector("#show-full-name").checked = showFullName;
      toggleFullName(showFullName);
      document
        .querySelector("#show-full-name")
        .addEventListener("click", (evt) => {
          toggleFullName(evt.target.checked);
        });

      const fileTree = document.getElementById("file-tree");
      fileTree.addEventListener("click", function (event) {
        const target = event.target;
        let dir = target;
        if (dir.tagName === "SPAN") {
          dir = dir.parentNode;
        }
        if (dir.classList.contains("directory")) {
          dir.classList.toggle("open");
          if (dir.classList.contains("open")) {
            foldedState[dir.getAttribute("data-path")] = true;
          } else {
            delete foldedState[dir.getAttribute("data-path")];
          }
          localStorage.setItem("foldedState", JSON.stringify(foldedState));
          event.stopPropagation();
        }
      });

      const fileLinks = document.querySelectorAll(".file");

      fileLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
          event.preventDefault(); // prevent the link from navigating
          const filePath = link.getAttribute("data-path");
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/file-clicked", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.send(JSON.stringify({ filePath: filePath }));
        });
      });
    </script>
  </body>
</html>
